{"version":3,"file":"usersettings_save.min.js","sources":["../src/usersettings_save.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to save the user settings in the database.\n *\n * This file implements 1 functionality:\n * - If the \"save settings\" button is pressed, store the settings in the database.\n *\n * @module     block_townsquare/usersettings_save\n * @copyright  2024 Tamaro Walter\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\n\n// Get the save button for the user settings.\nconst savebutton = document.getElementById('ts_usersettings_savebutton');\n\n// Get the buttons from the time filter.\nconst alltimebutton = document.querySelectorAll('.ts_all_time_button');\nconst futureradiobuttons = document.querySelectorAll('.ts_future_time_button');\nconst pastradiobuttons = document.querySelectorAll('.ts_past_time_button');\n\n// Get the checkboxes from the letter filter.\nconst letter_checkboxes = document.querySelectorAll('.ts_letter_checkbox');\n\n// Get the checkboxes from the course filter.\nconst course_checkboxes = document.querySelectorAll('.ts_course_checkbox');\n\n/**\n * Init function. This functions adapts the filter settings to the user settings from the database. If the user changes settings\n * and clicks the save button, the settings are stored in the database.\n *\n * @param {number} userid           The id of the current user.\n * @param {object} settingsfromdb   The settings from the database, if there are any.\n */\nexport function init(userid, settingsfromdb) {\n    // When the page is loaded, set the settings from the database.\n    if (settingsfromdb) {\n        executeusersettings(settingsfromdb);\n    }\n\n    // Add event listener to the save button.\n    savebutton.addEventListener('click', async function() {\n\n        // First step: collect the current settings.\n        // Get the relevant time spans of the time filter and the setting of the letter filter checkboxes.\n        let timespans = collecttimefiltersettings();\n        let letterfilter = collectletterfiltersettings();\n        let courses = collectcoursesettings(settingsfromdb.courses);\n\n        // Second step: store the usersettings in the database.\n        await saveusersettings(userid, timespans['timepast'], timespans['timefuture'], letterfilter['basicletter'],\n            letterfilter['completionletter'], letterfilter['postletter'], courses);\n    });\n}\n\n/**\n * Function to save the user settings in the database.\n * @param {number} userid\n * @param {number} timefilterpast\n * @param {number} timefilterfuture\n * @param {number} basicletter\n * @param {number} completionletter\n * @param {number} postletter\n * @param {string} courses\n * @returns {Promise<*>}\n */\nfunction saveusersettings(userid, timefilterpast, timefilterfuture, basicletter, completionletter, postletter, courses) {\n    let result;\n\n    const data = {\n        methodname: 'block_townsquare_record_usersettings',\n        args: {\n            userid: userid,\n            timefilterpast: timefilterpast,\n            timefilterfuture: timefilterfuture,\n            basicletter: basicletter,\n            completionletter: completionletter,\n            postletter: postletter,\n            courses: courses,\n        },\n    };\n    result = Ajax.call([data]);\n\n    // Make the clicked button green by adding a class and remove it afterward.\n    savebutton.classList.add('bg-success', 'text-white', 'ts_button_transition');\n    setTimeout(function() {\n        savebutton.classList.remove('bg-success');\n        savebutton.classList.remove('text-white');\n    }, 1500);\n\n    return result;\n\n}\n\n/**\n * Function to execute existing user settings when loading the townsquare.\n * @param {Object} settingsfromdb\n */\nfunction executeusersettings(settingsfromdb) {\n\n    // First step: set the time filter settings.\n    // Change the time into the correct radio button id.\n    let futurebuttonid = converttimetoid(settingsfromdb.timefilterfuture, true);\n    let pastbuttonid = converttimetoid(settingsfromdb.timefilterpast, false);\n\n    // If the time span is a combination of past and future, go through the two radio buttons and activate the filter.\n    if (futurebuttonid !== \"ts_time_all\") {\n        alltimebutton.forEach(function(alltimebutton) {\n            alltimebutton.checked = false;\n        });\n        futureradiobuttons.forEach(function(button) {\n            if (button.id === futurebuttonid) {\n                button.checked = true;\n                button.parentNode.classList.add('active');\n                button.dispatchEvent(new Event('change'));\n            }\n        });\n        pastradiobuttons.forEach(function(button) {\n            if (button.id === pastbuttonid) {\n                button.checked = true;\n                button.parentNode.classList.add('active');\n                button.dispatchEvent(new Event('change'));\n            }\n        });\n    } else {\n        // If the time span is set to all time, activate the all time button.\n        alltimebutton.forEach(function(button) {\n            button.checked = true;\n            button.parentNode.classList.add('active');\n            button.dispatchEvent(new Event('change'));\n        });\n        futureradiobuttons.forEach(function(button) {\n            button.checked = false;\n        });\n        pastradiobuttons.forEach(function(button) {\n            button.checked = false;\n        });\n    }\n\n    // Second step: set the letter filter settings.\n    // Per default all checkboxes are checked. If the setting is 0, uncheck the checkbox.\n    letter_checkboxes.forEach(function(checkbox) {\n        let basiclettercheck = checkbox.id === 'basicletter' && settingsfromdb.basicletter === \"0\";\n        let completionlettercheck = checkbox.id === 'completionletter' && settingsfromdb.completionletter === \"0\";\n        let postlettercheck = checkbox.id === 'postletter' && settingsfromdb.postletter === \"0\";\n\n        if (basiclettercheck || completionlettercheck || postlettercheck) {\n            checkbox.click();\n        }\n    });\n\n    // Third step: set the course filter settings.\n    let coursessettings = JSON.parse(settingsfromdb.courses);\n\n    course_checkboxes.forEach(function(checkbox) {\n        let courseid = Number(checkbox.dataset.courseid);\n        if (coursessettings.hasOwnProperty(courseid)) {\n            // If the setting is false, uncheck the checkbox.\n            if (!coursessettings[courseid] && checkbox.checked) {\n                checkbox.click();\n            }\n        }\n    });\n}\n\n/**\n * Function to collect the letter filter settings.\n * @returns {{basicletter: number, completionletter: number, postletter: number}}\n */\nfunction collectletterfiltersettings() {\n    let settings = {'basicletter': 0, 'completionletter': 0, 'postletter': 0 };\n\n    letter_checkboxes.forEach(function(checkbox) {\n        if (checkbox.checked) {\n            switch(checkbox.id) {\n                case \"basicletter\":\n                    settings.basicletter = 1;\n                    break;\n                case \"completionletter\":\n                    settings.completionletter = 1;\n                    break;\n                case \"postletter\":\n                    settings.postletter = 1;\n            }\n        }\n    });\n    // Calculate the setting number. It is a number between 0 and 7, and each letter represents a bit.\n    return settings;\n}\n\n/**\n * Collects and updates the course filter settings.\n * Ensures previous settings are retained even if a course does not show notifications temporarily..\n *\n * @param {?string} coursesettingsfromdb\n * @returns {string}\n */\nfunction collectcoursesettings(coursesettingsfromdb) {\n    // Check if the course settings have been set in the past.\n    let settings = coursesettingsfromdb ? JSON.parse(coursesettingsfromdb) : {};\n\n    // Build a JSON in the format courseid => coursename.\n    course_checkboxes.forEach(function(checkbox) {\n        settings[Number(checkbox.dataset.courseid)] = checkbox.checked;\n    });\n\n    // Return a string version of the settings.\n    return JSON.stringify(settings);\n}\n\n/**\n * Function to collect the time filter settings.\n * @returns {{timepast: number, timefuture: number}}\n */\nfunction collecttimefiltersettings() {\n    let settings = {timepast: 0, timefuture: 0};\n    let settingsset = false;\n\n    // Get the relevant time spans of the time filter.\n    // Check if the alltimebutton is set.\n    alltimebutton.forEach(function(button) {\n        if (button.checked || button.parentNode.classList.contains('active')) {\n            // Get the timespan.\n            settings.timepast = convertidtotime(button.id);\n            settings.timefuture = convertidtotime(button.id);\n            settingsset = true;\n        }\n    });\n\n    if (settingsset) {\n        return settings;\n    }\n\n    // If the alltimebutton is not set, check which of the future/past buttons is set.\n    futureradiobuttons.forEach(function(button) {\n        if (button.checked || button.parentNode.classList.contains('active')) {\n            // Get the timespan.\n            settings.timefuture = convertidtotime(button.id);\n        }\n    });\n\n    pastradiobuttons.forEach(function(button) {\n        if (button.checked || button.parentNode.classList.contains('active')) {\n            // Get the timespan.\n            settings.timepast = convertidtotime(button.id);\n        }\n    });\n    return settings;\n}\n\n\n/**\n * Function to convert the radio button id to a useable time span.\n * @param {string} id  The id of the radio button\n * @returns {number}\n */\nfunction convertidtotime(id) {\n    // TODO: Please use global functions if possible.\n    switch (id) {\n        case \"ts_time_all\":\n            return 15778463;\n        case \"ts_time_next_twodays\":\n        case \"ts_time_last_twodays\":\n            return 172800;\n        case \"ts_time_next_fivedays\":\n        case \"ts_time_last_fivedays\":\n            return 432000;\n        case \"ts_time_next_week\":\n        case \"ts_time_last_week\":\n            return 604800;\n        case \"ts_time_next_month\":\n        case \"ts_time_last_month\":\n            return 2592000;\n    }\n}\n\n/**\n * Function to convert the time span to a radio button id.\n * @param {string} time\n * @param {boolean} future\n * @returns {string}\n */\nfunction converttimetoid(time, future) {\n    switch (time) {\n        case \"15778463\":\n            return \"ts_time_all\";\n        case \"172800\":\n            if (future) {\n                return \"ts_time_next_twodays\";\n            }\n            return \"ts_time_past_twodays\";\n        case \"432000\":\n            if (future) {\n                return \"ts_time_next_fivedays\";\n            }\n            return \"ts_time_last_fivedays\";\n        case \"604800\":\n            if (future) {\n                return \"ts_time_next_week\";\n            }\n            return \"ts_time_last_week\";\n        case \"2592000\":\n            if (future) {\n                return \"ts_time_next_month\";\n\n            }\n            return \"ts_time_last_month\";\n    }\n}\n"],"names":["e","userid","settingsfromdb","futurebuttonid","converttimetoid","timefilterfuture","pastbuttonid","timefilterpast","alltimebutton","forEach","checked","futureradiobuttons","button","id","parentNode","classList","add","dispatchEvent","Event","pastradiobuttons","letter_checkboxes","checkbox","basiclettercheck","basicletter","completionlettercheck","completionletter","postlettercheck","postletter","click","coursessettings","JSON","parse","courses","course_checkboxes","courseid","Number","dataset","hasOwnProperty","executeusersettings","savebutton","addEventListener","async","timespans","settings","timepast","timefuture","settingsset","contains","convertidtotime","collecttimefiltersettings","letterfilter","collectletterfiltersettings","coursesettingsfromdb","stringify","collectcoursesettings","result","data","methodname","args","Ajax","call","setTimeout","remove","saveusersettings","_ajax","__esModule","default","document","getElementById","querySelectorAll","time","future"],"mappings":"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"}